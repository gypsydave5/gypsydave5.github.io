<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="rss.xml"
      title="RSS feed for "/>
<title>Bitwise and Permission</title>
<meta name="author" content="John Dow">
<meta name="referrer" content="no-referrer">
<link href= "static/style.css" rel="stylesheet" type="text/css" />
<link rel="icon" href="static/favicon.ico">
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="preamble" class="status">
<div class="header">
  <a href="https://staticblog.org">My Static Org Blog</a>
</div></div>
<div id="content">
<div class="post-date">16 Sep 2020</div><h1 class="post-title"><a href="/2014-08-15-bitwise-and-permissions.md.html">Bitwise and Permission</a></h1>
<p>
So I thought I'd try and write about what happened last day of the first
week at <a href="http://www.makersacademy.com/">Makers</a>, as mentioned in
<a href="file:///posts/2014/8/9/makers:-day-5/">my last post</a>, about the failing
RSpec test for the Unix task. Just because I learned a lot about both
permissions on a Unix like system, about bitwise operators in Ruby,
about how RSpec works, and how (not) to fix things.
</p>

<p>
So&#x2026; the test checking file permissions in a directory by running the
following RSpec test.
</p>

<div class="org-src-container">
<pre class="src src-ruby">it <span style="color: #666666;">"Should only allow the owner to change into my/private/files"</span> <span style="color: #333333; font-weight: bold;">do</span>
  folder = <span style="color: #666666;">"my/private/files"</span>
  permissions = <span style="color: #333333; font-weight: bold; font-style: italic;">File</span>.stat(folder).mode
  expect(permissions &amp; 0000100).to be_true
  expect(permissions &amp; 0000010).to eq(0)
  expect(permissions &amp; 0000001).to eq(0)
<span style="color: #333333; font-weight: bold;">end</span>
</pre>
</div>

<p>
When we first ran it, it failed on the first expectation above - even
though we knew that the file had the right permissions. So what was
going on - both in terms of how it was meant to work, and why it wasn't
working?
</p>

<div id="outline-container-org9ec89fd" class="outline-2">
<h2 id="permissions">Permissions</h2>
<div class="outline-text-2" id="text-permissions">
<p>
Let's start with that first expectation.
</p>

<div class="org-src-container">
<pre class="src src-ruby">expect(permissions &amp; 0000100).to be_true
</pre>
</div>

<p>
<code>permissions</code> is a variable representing the result of
<code>File.stat(folder).mode</code>, where <code>folder</code> is the directory being checked.
The <code>mode</code> method
<a href="http://www.ruby-doc.org/core-2.1.2/File/Stat.html#method-i-mode">returns
the permissions-bits of the Unix <code>stat</code> command</a> - which you can take a
look at in detail with a quick <code>man stat -a</code> (as it's <code>stat(2)</code> you're
looking at.
</p>

<p>
What does all this mean? It means that we're getting back an integer
which represents the current permissions on the file. And how does an
integer represent permissions? If you've been using <code>chmod</code> to change
permission with commands like <code>chmod go-w filename</code> (remove write from
group and others), well - you've been missing a trick and a whole lot of
fun.
</p>

<p>
The fun way to set permission is using the <i>absolute mode</i>, which sets
the permissions absolutely every time you use it (rather than relatively
removing or adding them from the current state - see <code>man chmod</code> for
more). There are three settings (read, write and execute) for each of
the three permissions groups (user, group, other) on a file. Each of
those permissions sets is represented by a single octal digit (from 1 to
7), and the settings are literally added to each one - the setting for
read is 4, write is 2 and execute is 1.
</p>

<p>
Any combination of these numbers will produce a unique number - read +
write = 6, write + execute = 3, just read = 4. And you can combine them
into a three-digit octal number which represents the file permissions
for any given file, where the first digit is user, the second is group
and the third is other.
</p>

<p>
In practice: <code>chmod 777</code> gives permissions for everything. <code>chmod 644</code>
gives read/write to user, and just read to group and other. <code>755</code> is
read/write/execute for user, and just read/execute for the group and
other.
</p>
</div>
</div>

<div id="outline-container-org2ca6486" class="outline-2">
<h2 id="the-science-bit">The science "bit"</h2>
<div class="outline-text-2" id="text-the-science-bit">
<p>
Notice how none of the octal numbers ever 'carry' over to the next one
when they're added together? This is a piece of computer science
wizzardry - because they're in octal, I can look at them as both an
actual integer or as a series of switches (or maybe dials), setting
permissions for each permissions group up and down. Thing is, for your
computer, these two ways of looking at it <i>are exactly the same</i>.
</p>

<p>
<code>777</code> in decimal notation is <code>511</code> (do the maths if you like), but also
has a binary representation of&#x2026; <code>111111111</code>. Hey, look - all the 1s!
It's like all the switches are turned on - and they really are!. This is
because octal digits map really neatly to binary digits - they're a
three-digit long collection of binary digits. 'Binary digit' is a bit of
a mouthful (pun intended), so let's use the shorthand word - bit. Each
set of three bits represents one of the permission statuses for a
particular permissions set. So the first three 1s above are the
permissions for the user, and in particular the first one is the read,
second write and the third the execute - all set to 1 or 'on'.
</p>

<p>
(Experiment in a Ruby repl like pry or irb - you can switch between
binary, octal and decimal really quickly in Ruby. Any integer you type
in with a leading <code>0</code> (say <code>0777</code>) will automatically be translated as
an octal (<code>0777</code> will return <code>511</code> - the decimal representation). And
you can flip to a binary representation with <code>to_s(2)</code> - the <code>(2)</code>
setting the base of the conversion, so that <code>0777.to_s(2)</code> will return
<code>"111111111"</code>. Try some other numbers!)
</p>

<p>
So when <code>mode</code> returns an integer, it's the integer that represents the
current permissions on that file - a file with read, write and exeute
permissions for all the sets would give you the number <code>511</code> (which is
the same as <code>777</code> and <code>111111111</code>).
</p>
</div>
</div>

<div id="outline-container-org31c4eff" class="outline-2">
<h2 id="bitwise">Bitwise</h2>
<div class="outline-text-2" id="text-bitwise">
<p>
Now we get to the fun stuff - <code>permissions &amp; 0000100</code>. What's the <code>&amp;</code>
doing? And those leading 0s? As mentioned above, the leading zeroes are
just Ruby's way of saying that this number is in octal. So (repls open)
<code>0000100</code> just becomes <code>64</code>. But the thing doing the work here is <code>&amp;</code> -
not our friendly Boolean <code>&amp;&amp;</code>, but a differnent beast - this is the
<a href="http://en.wikipedia.org/wiki/Bitwise_operation#AND"><b>bitwise AND</b></a>.
</p>

<p>
Bitwise operators, of which <code>&amp;</code> is an example, really tear the lid off
the computer and get a little bit closer to the bare metal. Computers
aren't made of objects, or lines of code, strings and integers. They're
made of 0s and 1s. And bitwise operators work on 0s and 1s - or,
specifically, binary numbers.
</p>

<p>
Let's take a pair of binary numbers, say <code>111</code> and <code>100</code> (known to you
and me as 7 and 4). Bitwise AND compares the bit in each position, and
asks the question "are you both <code>1</code>?" If they are, you get a <code>1</code>,
otherwise it's a <code>0</code>. So <code>111 &amp; 100</code> will return <code>100</code> as the third bit
(counting from the right) is the only one that matches in each number
</p>

<p>
(Think of it just like a regular logical AND - but <code>1</code> is <code>true</code> and <code>0</code>
is <code>false</code> - running on each bit position.)
</p>

<p>
We now have enough knowledge to look at the test again
</p>
</div>
</div>

<div id="outline-container-org4a3b861" class="outline-2">
<h2 id="back-to-the-test">Back to the test</h2>
<div class="outline-text-2" id="text-back-to-the-test">
<p>
To recap, the test looks like this:
</p>

<p>
`=ruby   it "Should only allow the owner to change into my/private/files" do     folder = "my/private/files"     permissions = File.stat(folder).mode     expect(permissions &amp; 0000100).to be<sub>true</sub>     expect(permissions &amp; 0000010).to eq(0)     expect(permissions &amp; 0000001).to eq(0)   end=
</p>

<p>
The key line being:
</p>

<div class="org-src-container">
<pre class="src src-ruby">expect(permissions &amp; 0000100).to be_true
</pre>
</div>

<p>
Now let's pretend that the directory currently has permissions of
<code>700</code> - read, write and execute ('execute' is 'open' for a folder &#x2013;
allowing you to <code>cd</code> into it). We run <code>mode</code> on it and get the
permissions integer back - in octal, that's <code>700</code> again. We then run a
bitwise AND - the <code>&amp;</code> against it using the octal number <code>100</code> (all those
=0=s at the beginning are just saying 'hey! I'm octal!' to Ruby).
</p>

<p>
Converting octal to binary, <code>700</code> is <code>111000000</code>, and <code>100</code> is <code>1000000</code>
(Don't trust me? Fire up a repl!). Maybe think of <code>1000000</code> as
<code>001000000</code> for the next bit. Comparing the two binary numbers, the only
place they match is at the seventh bit - and so we get <code>1000000</code> as the
returned value. Which, in octal is <code>100</code> and in decimal is <code>64</code>.
</p>

<p>
The neat thing about this is that it will return <code>64</code> for any permission
set that includes user executable permission on a file - <code>700</code>, <code>500</code>,
<code>177</code>, <code>355</code>, <code>777</code> &#x2013; they <i>all</i> work. Say we've got <code>355</code> - in binary
that's <code>011101101</code>. <code>&amp;=ing it with =001000000</code> again will give us&#x2026;
<code>001000000</code> again - hey, it's <code>64</code>! Try it with as many numbers as you
like.
</p>

<p>
The other two tests are to check whether the Group or Other sets also
have execute permission &#x2013; that's <code>010</code> becoming <code>000001000</code> and <code>001</code>
to <code>000000001</code>, bitwised against the permissions making sure they
<i>don't</i> have that bit set. They come out as <code>0</code> &#x2013; no matches!
</p>

<p>
And so that's how it all hangs together. But why didn't it work? Simply
put everyone on the course had just installed the latest version of
RSpec, and <code>be_true</code> is not in the latest version's syntax. So all we
needed to do was change <code>be_true</code> over to <code>eq(64)</code> and it would've been
fixed.
</p>

<p>
Of course, that's not what we <i>actually</i> did. What we did was hack
around until it worked, and even then we ended up with <code>is_not eq(0)</code>
instead of the neater (and more correct) answer of <code>eq(64)</code>. It was only
when thinking about it over the weekend that I really got a handle on
what was going on
</p>
</div>
</div>
<div class="taglist"></div></div>
<div id="postamble" class="status"><div id="archive">
  <a href="https://staticblog.org/archive.html">Other posts</a>
</div>
<center><a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/3.0/88x31.png" /></a><br /><span xmlns:dct="https://purl.org/dc/terms/" href="https://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">bastibe.de</span> by <a xmlns:cc="https://creativecommons.org/ns#" href="https://bastibe.de" property="cc:attributionName" rel="cc:attributionURL">Bastian Bechtold</a> is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.</center></div>
</body>
</html>
