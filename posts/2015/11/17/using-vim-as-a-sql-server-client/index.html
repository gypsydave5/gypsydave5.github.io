
<!DOCTYPE html>
<html lang="en">
  
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [['$','$'], ['\\(','\\)']],
          processEscapes: true,
      },
      displayAlign: "left",
      displayIndent: "1em",
      CommonHTML: { linebreaks: { automatic: true } },
      "HTML-CSS": { linebreaks: { automatic: true } },
      SVG       : { linebreaks: { automatic: true } }
    });
</script>
<script type="text/javascript"
        async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

  <link rel="stylesheet" href="/css/style.css">
  <title>Using Vim as a SQL Server Client</title>
</head>

  <body>
    <main>
    
<header>
  <section class="top">
    <h1><a href="/">gypsydave5</a></h1>
    <p>The blog of David Wickes, software developer</p>
  </section>

  <ul class="links">
    <li><a href="/pages/about/">about</a></li>
    <li><a href="/posts/">posts</a></li>
  </ul>
</header>

    
<article>
  <h1>Using Vim as a SQL Server Client</h1>
  <time datetime="2015-11-17T20:08" >Nov 17, 2015</time>
  <p>Bad times - having to connect to my company&rsquo;s SQL Server database in order to
migrate data. The last time I looked at that database it was through
a connection to a Windows box running the Microsoft development client. Laggy,
slow, and an unfamiliar environment.</p>

<p>So what are my options on a Mac? Well, there are a couple of SQL Server clients
out there, but the one I tried out turned out to be buggy - there&rsquo;s nothing
less fun than losing a query you&rsquo;ve been crafting for an hour. And why should
I spend time moving the query betweeen an editor (Vi) and an awkward GUI
interface?</p>

<p>Screw that - let&rsquo;s do it in Vim! This method has been tested on my Mac, but
should also work for another *nix based system. No guarantees though.</p>

<h3>The Tools</h3>

<p>To do this we need:</p>

<ul>
<li>a way for the Mac to talk to the SQL Server database</li>
<li>a way for that connection to talk to Vim</li>
</ul>

<p>And we will be using the following tools to do that:</p>

<ul>
<li><a href="http://www.freetds.org/">FreeTDS</a></li>
<li><a href="http://www.unixodbc.com/">unixODBC</a></li>
<li>the Vim plugin <a href="http://www.vim.org/scripts/script.php?script_id=356">dbext.vim</a></li>
<li>and the Perl libraries <a href="http://dbi.perl.org/">DBI</a> and <a href="http://search.cpan.org/~mjevans/DBD-ODBC-1.52/ODBC.pm">DBD::ODBC</a> (installed using <a href="http://search.cpan.org/~mjevans/DBD-ODBC-1.52/ODBC.pm">CPAN</a>)</li>
</ul>

<p>We&rsquo;ll start with a simple example - connecting dbext to a local instance of
PostgreSQL.</p>

<h3>dbext with PostgreSQL</h3>

<p>Install dbext into Vim using whichever package manager or other you like. Dbext
is a &lsquo;proper&rsquo; Vim extension, in that it comes with extensive documentation in
the form of Vim helpfiles. Access the full help with <code>:h dbext</code> and check out
the tutorial at <code>:h dbext-tutorial</code>.</p>

<p>If even the tutorial is fast enough, here&rsquo;s a quick start for
PostgreSQL locally. Let&rsquo;s assume you&rsquo;ve already installed PostgreSQL,
and that you&rsquo;ve not added any usernames or passwords. Somewhere in your Vim
initialization files (like <code>~/.vimrc</code>) add the following line:</p>

<p><code>let g:dbext_default_profile_local_PSQL = 'type=PGSQL'</code></p>

<p>Here we&rsquo;ve set up a local profile for PostgreSQL, called it <code>local_PSQL</code>, and
told dbext that the type of connection this profile will use is, well,
Postgres. Now either restart Vim or evaluate that command in your current session.</p>

<p>To use this profile with some SQL in Vim, first put some SQL into a buffer. Try
this: <code>SELECT * FROM bob</code>. Then, in the buffer, send the command
<code>:DBPromptForBufferParameters</code>. You&rsquo;ll get a menu with the <code>local_PSQL</code> option
on it. Select that option (probably option 1).</p>

<p>Now have a crack at running a query - put your cursor on the line with the SQL
statement on it and execute the query with the command <code>&lt;Leader&gt;sel</code> (<code>s</code>ql
<code>e</code>xecute <code>l</code>ine).</p>

<p>This won&rsquo;t work, but should give you a hint about what&rsquo;s going wrong: PostgreSQL
needs a <code>[.pgpass]</code> file for the password to the database - even if there isn&rsquo;t
a password(!). So just create an empty file called <code>.pgpass</code> in your <code>$HOME</code>
directory. Now it should work (or at least return a reasonable error message if
your default database doesn&rsquo;t have a <code>bob</code> table).</p>

<p>Now&hellip; go crazy! Dbext is great - read some of the docs in full and have a play
with some SQL queries. Ah, the joy of Vim! Come back when you want to hook it
up to a remote SQL Server.</p>

<h3>SQL Server on Mac</h3>

<p>Had fun? Right, this bit is a bit of a drag. Macs (and other *nix systems) have
no native support for TDS, the protocol by which we talk to SQL Server
databases. So we&rsquo;ll have to install a library called <code>freetds</code>.</p>

<p>But before we do that we&rsquo;ll need to install an ODBC driver as the <code>freetds</code>
library does not provide sufficiently sophisticated binaries for <code>dbext</code> to use
to query a database directly.<sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup></p>

<p>First up we&rsquo;ll install <code>unixodbc</code> - I&rsquo;m using <a href="http://brew.sh/">Homebrew</a>, but if you&rsquo;d
like to build your own binaries be my guest.</p>

<pre><code>brew install unixodbc
</code></pre>

<p>And now that&rsquo;s done, let&rsquo;s get hold of <code>freetds</code></p>

<pre><code>brew install freetds --with-unixodbc --with-msdblib
</code></pre>

<p>We&rsquo;re asking for <code>freetds</code> to be installed with <code>unixodbc</code> support, and telling
it that we want it to use the version of TDS that Microsoft developed for SQL
Server.<sup class="footnote-ref" id="fnref:2"><a rel="footnote" href="#fn:2">2</a></sup></p>

<p>If you&rsquo;d like to test the installation, <code>freetds</code> comes with a couple of command
line tools you can use to connect to a SQL Server DB. Run <code>tsql</code> with the
appropriate server, port, username and password passed in as options and check
to see if you can connect. Have a bit more of a play around if you can - you&rsquo;ve
earned it.</p>

<h3>Perl: <code>DBI</code> and <code>DBD::ODBC</code></h3>

<p>The final step is to get <code>dbext</code> talking to the ODBC installation. And it wants
to do this through a pair of Perl libraries. We&rsquo;ll install these using CPAN, the
Perl equivalent of RubyGems or NPM.<sup class="footnote-ref" id="fnref:3"><a rel="footnote" href="#fn:3">3</a></sup> First start the interactive interface as
the super user:</p>

<pre><code>sudo perl -MCPAN -e shell
</code></pre>

<p>And then install the libraries we need:</p>

<pre><code>install DBI
install DBD::ODBC
</code></pre>

<p>Both of these will output a scarily verbose amount of logs - it&rsquo;s ok, it&rsquo;s
normal<sup class="footnote-ref" id="fnref:4"><a rel="footnote" href="#fn:4">4</a></sup> - and by the end of it we&rsquo;ve got everything installed that we&rsquo;ll
need. Almost there. Almost&hellip;</p>

<h3>Configuration files</h3>

<p>Getting <code>freetds</code> and <code>unixodbc</code> working together happily is super simple -
but it took me a while to work out exactly what was needed. Configuration for
<code>freetds</code> can live either in its own configuration file, or with the ODBC
configuration. The simplest thing to do is to push the configuration over to the
ODBC side entirely.</p>

<p>What we&rsquo;re looking to do it to tell ODBC that there is a sort of database called
&lsquo;freeTDS&rsquo; and to point it to where the files that describe the protocol live -
this is the database &lsquo;driver&rsquo;, just like a printer driver.  Then we need to give
ODBC the details of the specific database we want to connect to - think of this
as the specific printer you connect to using a printer driver, the network
address etc.</p>

<p>The first step is to register <code>freetds</code> as a driver with <code>unixodbc</code> - this is
done in a file called <code>odbcinst.ini</code> which Homebrew has (hopefully) symlinked
into <code>/usr/local/etc/odbcinst.ini</code><sup class="footnote-ref" id="fnref:5"><a rel="footnote" href="#fn:5">5</a></sup>. And in that file we put the following:</p>

<pre><code>[FreeTDS]
Description = TD Driver (MSSQL)
Driver = /usr/local/lib/libtdsodbc.so
Setup = /usr/local/lib/libtdsodbc.so
FileUsage = 1
</code></pre>

<p>The top line is the name we&rsquo;re giving the driver, the second a human-friendly
description of what it does. Thee next two lines give ODBC the driver and set up
information - <code>libsdsodbc.so</code> was installed with the <code>freeTDS</code> installation and
put in <code>/usr/local/lib</code> as a symlink by Homebrew (again, hopefully).</p>

<p>That&rsquo;s the driver bit done. Now let&rsquo;s point ODBC to your SQL Server database by
adding its details to the <code>~/.odbc.ini</code> file, which you&rsquo;ll have to create.<sup class="footnote-ref" id="fnref:6"><a rel="footnote" href="#fn:6">6</a></sup>
Put the following in there:</p>

<pre><code>[MyMSSQLDB]
Driver = FreeTDS
Server = &lt;ip or domain name goes here&gt;
Database = &lt;database name goes here&gt;
Port = &lt;port number&gt;
</code></pre>

<p>This connection information is called a DSN<sup class="footnote-ref" id="fnref:7"><a rel="footnote" href="#fn:7">7</a></sup>, and we&rsquo;ll be using it in <code>dbext</code>.
Replace <code>MyMSSQLDB</code> with something more descriptive - it&rsquo;s the name of the
connection to your database that ODBC (and, by extension, <code>dbext</code>) will use.</p>

<p>Success! One more small step to go</p>

<h3>ODBC in <code>dbext</code></h3>

<p>Now we&rsquo;ve got an ODBC connection to play with, it&rsquo;s time to put its details into
<code>dbext</code>. This can bedone by putting the following into your <code>.vimrc</code> - right
next to where you declared your PostgreSQL connection information.</p>

<p><code>let g:dbext_default_profile_MyMSSQLDB = 'type=ODBC:user=&lt;username&gt;:passwd=&lt;password&gt;:dsnname=MyMSSQLDB'</code><sup class="footnote-ref" id="fnref:8"><a rel="footnote" href="#fn:8">8</a></sup></p>

<p>Pretty long, right? But comprehendible. We&rsquo;re giving similar information to that
which we used for the PostgreSQL connection, only we&rsquo;re declaring that the type
is <code>ODBC</code>, and we&rsquo;re declaring the DSN name that we&rsquo;re using as well.</p>

<p>And that&rsquo;s it. Restart your Vim Session, <code>&lt;Leader&gt;sbp</code> (it&rsquo;s the same as
<code>:DBPromptForBufferParameters</code>) and pick MyMSSQLDB (feel free to give it
a better name later). You can now evaluate lines of SQL against the database,
and see the return value in a separate split below.</p>

<h3>tl;dr</h3>

<ul>
<li><code>brew install unixodbc</code></li>
<li><code>brew install freetds --with-unixodbc --with-msdblib</code></li>
<li><code>sudo perl -MCPAN -e shell</code></li>
<li><code>install DBI</code> and <code>install DBD::ODBC</code> in the CPAN shell</li>
<li>Add the following to <code>/usr/local/etc/odbcinst.ini</code>:</li>
</ul>

<pre><code>[FreeTDS]
Description = TD Driver (MSSQL)
Driver = /usr/local/lib/libtdsodbc.so
Setup = /usr/local/lib/libtdsodbc.so
FileUsage = 1
</code></pre>

<ul>
<li>Add the following to <code>~/.odbc.ini</code>:</li>
</ul>

<pre><code>[MyMSSQLDB]
Driver = FreeTDS
Server = &lt;ip or domain name goes here&gt;
Database = &lt;database name goes here&gt;
Port = &lt;port number&gt;
</code></pre>

<ul>
<li>install <code>dbext</code> into Vim</li>
<li>Add <code>let g:dbext_default_profile_MyMSSQLDB = 'type=ODBC:user=&lt;username&gt;:passwd=&lt;password&gt;:dsnname=MyMSSQLDB'</code> to <code>~/.vimrc</code></li>
<li>Read the <code>dbext</code> manual (<code>:h dbext</code>)</li>
</ul>

<div class="footnotes">

<hr />

<ol>
<li id="fn:1">My details are <em>fuzzy</em> at best, but as far as I can see the <code>osql</code> and <code>tsql</code> bins that come with <code>freetds</code> are not set up for interactive querying, and can&rsquo;t be used in the same way that, say, <code>osql</code> on a Windows machine would work.</li>

<li id="fn:2">Even when making their own standard, M$ can&rsquo;t help but diverge from it.</li>

<li id="fn:3">Or Maven or whatever.</li>

<li id="fn:4">CPAN is running all the tests on each of the modules. Bit excessive I know.</li>

<li id="fn:5">This inforamation can also be added using the <code>odbcinst</code> tool, But this way seems easier to me. Read more about these files in the unixODBC documentation  <a href="http://www.unixodbc.org/odbcinst.html">here</a></li>

<li id="fn:6">ODBC will also look in <code>/usr/local/etc/odbc.ini</code> for DSNs, but these will be available to all users. So we&rsquo;re putting them in the local user file it checks, <code>~/.odbc.ini</code>.</li>

<li id="fn:7">Data Source Name - just so you know.</li>

<li id="fn:8">The connection information used here can include the database, but we&rsquo;ve pushed that part down to the DSN defined above. It must always include the <code>username</code> and <code>passwd</code> from what I&rsquo;ve seen through experimentation.</li>
</ol>

</div>

</article>

    </main>
  </body>
</html>
